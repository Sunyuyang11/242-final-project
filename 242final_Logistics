import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LogisticRegression
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import classification_report, roc_auc_score, roc_curve


df = pd.read_csv('cleaned_shelter_data.csv')
def train_evaluate_model(df, feature_cols, model_name, target_col='is_adopted'):
    """
    è¾“å…¥: æ•°æ®æ¡†, ç‰¹å¾åˆ—åˆ—è¡¨, æ¨¡å‹åç§°
    è¾“å‡º: æ¨¡å‹å¯¹è±¡, X_test, y_test, y_pred_proba, metricså­—å…¸
    """
    print(f"\n======== æ­£åœ¨è®­ç»ƒ: {model_name} ========")
    
    # 1. å‡†å¤‡ X å’Œ y
    X_raw = df[feature_cols].copy()
    y = df[target_col]
    
    # 2. æ•°å€¼å˜é‡æ ‡å‡†åŒ– (Scaling) - è¿™é‡Œä¸»è¦æ˜¯ Age_Months
    # é€»è¾‘å›å½’å¯¹æ•°å€¼èŒƒå›´å¾ˆæ•æ„Ÿï¼Œå¿…é¡»åš Standard Scaling
    scaler = StandardScaler()
    if 'Age_Months' in X_raw.columns:
        X_raw['Age_Months'] = scaler.fit_transform(X_raw[['Age_Months']])
    
    # 3. ç‹¬çƒ­ç¼–ç  (One-Hot Encoding)
    # drop_first=True é˜²æ­¢å¤šé‡å…±çº¿æ€§
    X = pd.get_dummies(X_raw, drop_first=True)
    
    # 4. æ‹†åˆ†è®­ç»ƒé›†/æµ‹è¯•é›†
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)
    
    # 5. è®­ç»ƒé€»è¾‘å›å½’
    # class_weight='balanced' è‡ªåŠ¨å¤„ç†æ ·æœ¬ä¸å¹³è¡¡
    model = LogisticRegression(random_state=42, max_iter=2000, class_weight='balanced')
    model.fit(X_train, y_train)
    
    # 6. é¢„æµ‹
    y_pred = model.predict(X_test)
    y_pred_proba = model.predict_proba(X_test)[:, 1]
    
    # 7. è®¡ç®—æŒ‡æ ‡
    auc = roc_auc_score(y_test, y_pred_proba)
    print(f"ROC-AUC Score: {auc:.4f}")
    print("Classification Report:")
    print(classification_report(y_test, y_pred))
    
    # 8. æå–ç‰¹å¾é‡è¦æ€§ (Top 10)
    coef_df = pd.DataFrame({'Feature': X.columns, 'Coefficient': model.coef_[0]})
    coef_df['Abs_Val'] = coef_df['Coefficient'].abs()
    top_features = coef_df.sort_values(by='Abs_Val', ascending=False).head(10)
    print(f"--- {model_name} Top 10 Features ---")
    print(top_features[['Feature', 'Coefficient']])
    
    return {
        'model': model,
        'auc': auc,
        'X_test': X_test,
        'y_test': y_test,
        'y_pred_proba': y_pred_proba,
        'top_features': top_features
    }

# ==============================================================================
# ğŸš€ è®­ç»ƒ Model A: Basic Model (æ— å­£èŠ‚å› ç´ )
# ==============================================================================
# æ’é™¤ ID, Target, æ—¥æœŸ, ä»¥åŠ Season/Month
basic_cols = [c for c in df.columns if c not in ['is_adopted', 'Season', 'Intake_Month']]
# ç¡®ä¿åªåŒ…å«æœ‰æ•ˆç‰¹å¾ (å†æ¬¡è¿‡æ»¤ä¸€ä¸‹ï¼Œé˜²æ­¢æ··å…¥æ‚è´¨)
valid_basic_cols = ['Animal Type', 'Sex', 'Intake Condition', 'Intake Type', 'Color_Simple', 'Age_Months']
# å¦‚æœä½ æœ‰ Breed åˆ—ï¼Œè®°å¾—åŠ ä¸Š
if 'Breed' in df.columns: valid_basic_cols.append('Breed')

results_basic = train_evaluate_model(df, valid_basic_cols, "Model A (Basic)")

# ==============================================================================
# ğŸš€ è®­ç»ƒ Model B: Seasonal Model (åŠ å…¥å­£èŠ‚å› ç´ )
# ==============================================================================
seasonal_cols = valid_basic_cols + ['Season']

# è®­ç»ƒ Seasonal
results_seasonal = train_evaluate_model(df, seasonal_cols, "Model B (With Season)")

# ==============================================================================
# ğŸ“Š ç»“æœå¯¹æ¯”ä¸ç”»å›¾
# ==============================================================================
plt.figure(figsize=(10, 8))

# ç”» Model A æ›²çº¿
fpr_a, tpr_a, _ = roc_curve(results_basic['y_test'], results_basic['y_pred_proba'])
plt.plot(fpr_a, tpr_a, label=f"Model A (Basic), AUC={results_basic['auc']:.3f}", color='blue', linestyle='--')

# ç”» Model B æ›²çº¿
fpr_b, tpr_b, _ = roc_curve(results_seasonal['y_test'], results_seasonal['y_pred_proba'])
plt.plot(fpr_b, tpr_b, label=f"Model B (With Season), AUC={results_seasonal['auc']:.3f}", color='red')

plt.plot([0, 1], [0, 1], 'k--', alpha=0.5) # å¯¹è§’çº¿
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.title('Model Comparison: Basic vs. Seasonal Factors')
plt.legend(loc='lower right')
plt.grid(True)
plt.show()

# å¯¹æ¯” Top ç‰¹å¾
print("\n========== å…³é”®å‘ç° ==========")
season_coefs = results_seasonal['top_features']
season_rows = season_coefs[season_coefs['Feature'].str.contains('Season')]
if not season_rows.empty:
    print("å­£èŠ‚å› ç´ åœ¨ Model B ä¸­çš„è¡¨ç°:")
    print(season_rows)
else:
    print("å­£èŠ‚å› ç´ æœªè¿›å…¥ Top 10 é‡è¦æ€§åˆ—è¡¨ï¼Œå¯èƒ½å½±å“è¾ƒå°ã€‚")